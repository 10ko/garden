#!/usr/bin/env bash
set -eo pipefail

garden_root=$(cd `dirname $0` && cd $(git rev-parse --show-toplevel) && pwd)
cd ${garden_root}

npm install
lerna bootstrap

npm run clean
./bin/check-if-clean

lerna version --no-push
git reset HEAD~1

# TODO: set this up to work with multiple packages
cd garden-cli
../node_modules/.bin/conventional-changelog -p angular -i CHANGELOG.md --commit-path . -s
git add CHANGELOG.md
version=$(node -p "require('./package.json').version")
git commit -m "chore(release): release ${version}"

cd ..

lerna publish from-git "$@"

git push --tags --no-verify
git push --no-verify

cd garden-cli
gulp update-brew
