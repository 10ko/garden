#!/usr/bin/env bash
set -eo pipefail

garden_root=$(cd `dirname $0` && cd $(git rev-parse --show-toplevel) && pwd)
cd ${garden_root}

./bin/prepare-publish

lerna version --no-push
git reset HEAD~1

./node_modules/.bin/conventional-changelog -p angular -i CHANGELOG.md --commit-path . -s
git add CHANGELOG.md
version=$(node -p "require('./lerna.json').version")
git commit -m "chore(release): release ${version}"

git push --tags --no-verify
git push --no-verify

# TODO: set this up to work with multiple packages
cd garden-cli
npm publish
gulp update-brew
