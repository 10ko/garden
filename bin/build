#!/usr/bin/env bash

set -e

garden_root=$(cd `dirname $0` && cd $(git rev-parse --show-toplevel) && pwd)

WATCH=''
TARGET_DIR="build"

for i in "$@"
do
case $i in
    -w*|--watch*)
    WATCH="-w"
    ;;
esac
done

cd ${garden_root}

rm -rf build/bin || true
rm -rf build/static || true
mkdir -p build/src

cp package.json build/
cp package-lock.json build/
cp -r bin build/bin
cp -r static build/static
cp .snyk ${TARGET_DIR}/

node_modules/.bin/pegjs -o build/src/template-string-parser.js src/template-string.pegjs
node_modules/.bin/tsc ${WATCH} -p . --outDir build/src
