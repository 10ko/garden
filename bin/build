#!/usr/bin/env bash

set -e

garden_root=$(cd `dirname $0` && cd $(git rev-parse --show-toplevel) && pwd)

WATCH=""
TARGET_DIR="build"

for i in "$@"
do
case $i in
    -w*|--watch*)
    WATCH="-w"
    ;;
    --dist*)
    TARGET_DIR="dist"
    ;;
esac
done

cd ${garden_root}

rm -rf ${TARGET_DIR}/bin || true
rm -rf ${TARGET_DIR}/static || true
mkdir -p ${TARGET_DIR}/src

cp package.json ${TARGET_DIR}/
cp package-lock.json ${TARGET_DIR}/
cp .snyk ${TARGET_DIR}/
cp -r static ${TARGET_DIR}/static

node_modules/.bin/pegjs -o ${TARGET_DIR}/src/template-string-parser.js src/template-string.pegjs
node_modules/.bin/tsc ${WATCH} -p . --outDir ${TARGET_DIR}/src
